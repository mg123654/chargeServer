# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此仓库中工作提供指导。

## 项目概述

该仓库包含**充电站服务器通信协议**规范。它定义了充电终端设备（硬件）与后端服务器之间的二进制/文本协议。这是一个仅包含规范的仓库，没有源代码、构建系统或测试。

**关键上下文：**
- 协议主要由服务器发起控制命令，由终端发起状态报告
- 每个终端支持最多 2 个充电插座
- 使用基于会话的身份验证（登录/登出）
- 为关键的结束事件消息实现可靠传输（重试直到服务器确认）

## 协议结构

`charge_protcol` 文件定义了 9 种主要协议场景：

### 1. 身份验证
- **登录场景：** 终端使用 `LOGIN usr pwd vision` 进行身份验证 → 服务器响应 `Logon`
- 会话在不活动后超时；终端必须重新身份验证才能继续
- 会话超时后，无效命令返回 `unknown`

### 2. 时间同步
- **获取时间：** 终端发送 `GETTIME` → 服务器响应 `time [YYYYMMDDHHMMSSMMM] [校验和]`
- 校验和是时间戳字符串中所有单个数字的总和
- 对能源计费和会话管理至关重要

### 3. 心跳保活
- **心跳：** 终端发送 `PING` → 服务器响应 `pong`

### 4. 固件更新
- **OTA 命令：** 服务器发送 `update [version]` → 终端响应 `update start` 或 `update success`
- 测试模式使用 PUT 命令进行调试消息传输

### 5. 充电控制
- **开始充电：** 服务器发送 `on [sock] [time] [orderid]`
  - `sock`: 1=左插座, 2=右插座（从 1 开始索引）
  - `time`: 0=无限制（最多 720 分钟）, 1-720=分钟数, >720=限制为 720
  - 终端必须用序号 0 的电流报文响应，否则服务器每 5 秒重试一次
- **停止充电：** 服务器发送 `off [sock] [orderid]` → 终端立即停止并发送结束事件

### 6. 实时数据采集
- **电流报文：** 终端发送 `log data [orderid] [seq] [sock] [current] [power] [voltage] [usetime]`
  - 在活跃充电期间定期发送
  - 服务器不响应
  - 包括：电流 (A)、功率 (W)、电压 (V)、已用时间（分钟）

### 7. 充电会话结束
- **结束事件：** 终端发送 `log over [orderid] [energy_kwh] [duration] [reason]`
  - 结束原因：0=时长用完, 1=电流过小, 2=电流过大, 3=没有插入用电器, 4=保险丝熔断, 5=手动停止
  - 可靠传输：终端无限重试直到服务器响应 `over [orderid]`
  - 计费关键—必须不丢失此消息

### 8. 自定义命令
- `reboot`: 终端重启命令
- `cat_data`: 数据回读命令
- 两者都支持调试 PUT 命令用于测试

## 常见开发场景

### 理解协议流程
- **阅读文件：** `charge_protcol` 包含完整规范
- **关键实现细节：** 命令是同步的，带有超时处理（服务器命令的 5 秒重试间隔）
- **关键路径：** 身份验证 → 获取时间 → 充电命令 → 结束事件（必须被确认）

### 为终端实现协议
- 必须处理服务器超时并在不活动后重新身份验证
- 电流报文应在充电期间以合理的间隔发送（未指定—检查终端固件）
- 结束事件必须无限重试直到被确认（如果需要，实现持久队列）
- 插座选择是从 1 开始索引，不是从 0（常见陷阱）

### 为服务器实现协议
- 必须跟踪会话超时并使不活动的会话无效
- 必须可靠地响应结束事件—未能响应会导致终端无限重试
- 服务器可以独立发送命令（非请求-响应）
- OTA 更新是异步的—通过响应消息跟踪完成情况

### 添加协议扩展
- 新场景应遵循现有的请求-响应或服务器发起的模式
- 保持与现有身份验证和超时机制的兼容性
- 清楚地记录结束原因和错误场景
